# -*-shell-script-*-
set -x

java=`which java`
echo "Using $java"

app_name=`echo $app_dir | awk -F/ '{print $NF}'`

install_app() {
    echo "Installing uni-tenant torquebox"
    torquebox_dir=$app_dir/torquebox2
    cp -rf $plugin_dir/torquebox2 $torquebox_dir
    chmod +x $torquebox_dir/jruby/bin/*

    echo "Setting environment variables"
    export TORQUEBOX_HOME=$torquebox_dir
    export JBOSS_HOME=$TORQUEBOX_HOME/jboss
    export JRUBY_HOME=$TORQUEBOX_HOME/jruby
    export PATH=$JRUBY_HOME/bin:$PATH

    echo "JRUBY_HOME = $JRUBY_HOME"
    echo "PATH = $PATH"
    echo "which jruby `which jruby`"

    echo "Copying app source from $pkg_dir to $app_dir"
    cp -a $pkg_dir/ $app_dir/

    echo "Installing Torquebox gem" 
    jruby -S gem install torquebox --no-ri --no-rdoc
    echo "Installing jruby-openssl and bundler"
    jruby -S gem install jruby-openssl bundler --no-ri --no-rdoc

    echo "Deploying app $app_name to torquebox"
    #TODO pass in ENVIRONMENT --env=production|test|development
    jruby --1.9 -S torquebox deploy $app_dir --name=$app_name

}

create_app_skel() {
    chmod 770 $app_dir
    mkdir -m 770 $app_dir
    mkdir -m 770 $app_dir/log
    mkdir -m 770 $app_dir/tmp
}

write_config() {
    config="$control_dir/config"
    echo "app_dir=$app_dir" >> $config
    echo "port=$app_port" >> $config
    echo "java=$java" >> $config
    torquebox_home=$torquebox_dir
    jruby_home=$torquebox_home/jruby
    echo "export TORQUEBOX_HOME=$torquebox_dir" >> $config
    echo "export JBOSS_HOME=$torquebox_home/jboss" >> $config
    echo "export JRUBY_HOME=$torquebox_home/jruby" >> $config
    echo "export PATH=$jruby_home/bin:$PATH" >> $config

    set +u
    echo "environment=$staxcat_appserver_env" >> $config
    set -u
}

# write_java_opts() {
#     java_opts_core="$control_dir/java-opts-10-core"
#     set +u
#     resolved_opts=$(eval "echo $staxcat_java_opts")
#     set -u
#     echo $resolved_opts > $java_opts_core
# }

# write_appserver_xml() {
#     echo "placeholder"
# }

write_control() {
    echo "Installing $plugin_dir/control/start to $control_dir"
    install -m 550 $plugin_dir/control/start $control_dir
    echo "Installing $plugin_dir/control/stats-appstat to $control_dir"
    install -m 550 $plugin_dir/control/stats-appstat $control_dir
}

install_app_gems(){

    if [ -f "$app_dir/Gemfile" ]; then
        cd $app_dir
        echo "Installing gems specified in $app_dir/Gemfile"
        jruby -S bundle install
        cd $OLDPWD    
    fi

}

create_app_skel
echo "Installing app...."
install_app
echo "Writing Config...."
write_config
# write_java_opts
# write_appserver_xml
echo "Writing control files...."
write_control
echo "Installing bundle...."
install_app_gems
